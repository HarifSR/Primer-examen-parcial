<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Progreso – Indicadores Censo | Ricardo–1890-22-3562</title>

 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --primary: #0d6efd; }
    body { background: #0b1220; color: #e6e9ef; }
    .card { background: #121a2a; border: 1px solid #223150; }
    .badge-soft { background: #1b2741; border: 1px solid #27406d; }
    .key { font-variant: all-small-caps; letter-spacing: .4px; color:#9fb3d1 }
    .value { font-weight: 600; color:#fff }
    .spinner { height: 2rem; width: 2rem; border-width: .25rem; }
    a, a:hover { color:#9fd1ff }
    .table thead th { color:#9fb3d1; border-bottom: 1px solid #27406d }
    .table tbody td { border-color:#223150 }
    .progress { background:#1b2741 }
    .footer { color:#9fb3d1 }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg" style="background:#121a2a;border-bottom:1px solid #223150">
    <div class="container">
      <a class="navbar-brand fw-bold text-white" href="#">
        <i class="bi bi-bar-chart-steps me-2"></i> Censo – El Progreso
      </a>
      <span class="navbar-text small">Harif Ricardo Samayoa Ruiz–1890-22-3562</span>
    </div>
  </nav>

  <main class="container py-4">
    
    <div class="row g-3 align-items-end">
      <div class="col-12 col-md-6">
        <label for="selMunicipio" class="form-label">Área</label>
        <select id="selMunicipio" class="form-select">
          
        </select>
        <div class="form-text">La consulta es dinámica: Departamento (999) o cualquier municipio (201–208).</div>
      </div>
      <div class="col-12 col-md-3">
        <button id="btnRecargar" class="btn btn-primary w-100">
          <i class="bi bi-arrow-clockwise me-1"></i>Recargar datos
        </button>
      </div>
      <div class="col-12 col-md-3 text-md-end">
        <span id="estado" class="badge rounded-pill badge-soft">Listo</span>
      </div>
    </div>

   
    <section class="mt-4">
      <div class="row g-3" id="kpis">
        <div class="col-6 col-lg-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="key">Población total</div>
              <div class="display-6 value" id="kTotal">—</div>
              <div class="small text-secondary">Fuente: API del Censo</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="key">Hombres</div>
              <div class="value fs-3" id="kHombres">—</div>
              <div class="progress mt-2"><div id="pHombres" class="progress-bar" style="width:0%"></div></div>
              <div class="small text-secondary" id="kHombresPct">—</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="key">Mujeres</div>
              <div class="value fs-3" id="kMujeres">—</div>
              <div class="progress mt-2"><div id="pMujeres" class="progress-bar" style="width:0%"></div></div>
              <div class="small text-secondary" id="kMujeresPct">—</div>
            </div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="key">Urbana vs. Rural</div>
              <div class="value fs-6" id="kUrbRur">—</div>
              <div class="progress mt-2"><div id="pUrbano" class="progress-bar" style="width:0%"></div></div>
              <div class="small text-secondary" id="kUrbanoPct">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>

  
    <section class="mt-4">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Población por sexo</h6>
                <span class="badge rounded-pill badge-soft">Gráfico</span>
              </div>
              <canvas id="chartSexo" height="140"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Población por grandes grupos de edad</h6>
                <span class="badge rounded-pill badge-soft">Gráfico</span>
              </div>
              <canvas id="chartEdad" height="140"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Población por pueblos -->
<section class="mt-4">
  <div class="card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Población por pueblos</h6>
        <span class="badge rounded-pill badge-soft">API</span>
      </div>
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr><th>Pueblo</th><th class="text-end">Personas</th><th class="text-end">%</th></tr>
              </thead>
              <tbody id="tbodyPueblos"></tbody>
              <tfoot>
                <tr>
                  <th>Total</th>
                  <th class="text-end" id="pueblosTotal">—</th>
                  <th class="text-end" id="pueblosPctTotal">100%</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <canvas id="chartPueblos" height="160"></canvas>
        </div>
      </div>
    </div>
  </div>
</section>
    
    <section class="mt-4">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Indicadores expuestos por la API</h6>
            <span class="badge rounded-pill badge-soft" id="badgeTotalInd">0 indicadores</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead><tr><th>Indicador</th><th class="text-end">Valor</th></tr></thead>
              <tbody id="tbodyInd"></tbody>
            </table>
          </div>
          <div class="small text-secondary">Se listan todas las claves entregadas por la API, con etiquetas legibles.</div>
        </div>
      </div>
    </section>

    <section class="mt-4 text-end footer">
      <span id="fuente">Fuente: API Censo (El Progreso) – <code>/API/indicadores/2/{código}</code></span>
    </section>
  </main>

<script>
const API_URL_BASE = 'https://censopoblacion.azurewebsites.net/API/indicadores/2/';

const municipios = [
  { codigo: '999', nombre: 'El Progreso (Departamental)' },
  { codigo: '201', nombre: 'Guastatoya' },
  { codigo: '202', nombre: 'Morazán' },
  { codigo: '203', nombre: 'San Agustín Acasaguastlán' },
  { codigo: '204', nombre: 'San Cristóbal Acasaguastlán' },
  { codigo: '205', nombre: 'El Jícaro' },
  { codigo: '206', nombre: 'Sansare' },
  { codigo: '207', nombre: 'Sanarate' },
  { codigo: '208', nombre: 'San Antonio la Paz' }
];


const municipioSelector = document.getElementById('municipioSelector');
const datosCensoDiv = document.getElementById('datosCenso');


const fmt = (n) => n===null||n===undefined||n===''||isNaN(n) ? '—' : Number(n).toLocaleString('es-GT');


function extractPueblos(data){
  const entries = Object.entries(data || {});
  const pick = (rx) => {
    const hit = entries.find(([k]) => rx.test(k));
    return hit ? Number(hit[1]) || 0 : 0;
  };

  const pueblos = [
    { name:'Maya',   value: pick(/pueblo.*maya|maya/i) },
    { name:'Garífuna', value: pick(/pueblo.*gar[ií]funa|gar[ií]funa/i) },
    { name:'Xinka',  value: pick(/pueblo.*xinka|xinka/i) },
    { name:'Afrodescendiente/Creole/Afromestizo', value: pick(/pueblo.*afro|creole|afromest/i) },
    { name:'Ladino', value: pick(/pueblo.*ladin|ladin/i) },
    { name:'Extranjero', value: pick(/pueblo.*extra(njero)?|extranj/i) }
  ];

 
  return pueblos.filter(p => p.value > 0);
}

function cargarMunicipios() {
  municipios.forEach(municipio => {
    const option = document.createElement('option');
    option.value = municipio.codigo;
    option.textContent = municipio.nombre;
    municipioSelector.appendChild(option);
  });
}


async function obtenerDatosCenso(codigoMunicipio) {
  const url = `${API_URL_BASE}${codigoMunicipio}`;
  datosCensoDiv.innerHTML = `
    <div class="col-12 text-center p-5">
      <p>Cargando datos...</p>
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>`;

  try {
    const response = await fetch(url, { cache: 'no-store' });
    if (!response.ok) throw new Error('No se pudo obtener la información de la API');

    
    let dataText = await response.text();
    dataText = dataText.substring(1, dataText.length - 1).replace(/\\"/g, '"');

    let data = JSON.parse(dataText);
    if (Array.isArray(data)) data = data[0];

    mostrarDatos(data);
    history.pushState(null, '', `?municipio=${codigoMunicipio}`);

  } catch (error) {
    console.error("Error al obtener datos:", error);
    datosCensoDiv.innerHTML = `
      <div class="col-12">
        <div class="alert alert-danger" role="alert">
          Ocurrió un error al cargar los datos. Intenta de nuevo.
        </div>
      </div>`;
  }
}

function mostrarDatos(data) {
  datosCensoDiv.innerHTML = ''; 
  if (!data) {
    datosCensoDiv.innerHTML = `<div class="col-12"><p class="text-center text-muted">No se encontraron datos para este municipio.</p></div>`;
    return;
  }

  const ubicacion = data["nombre"];

  const gruposDeDatos = {
    "Población": {
      "Población total": data["pob_total"],
      "Población masculina": data["total_sexo_hombre"],
      "Población femenina": data["total_sexo_mujeres"],
      "Porcentaje de hombres": data["porc_sexo_hombre"],
      "Porcentaje de mujeres": data["porc_sexo_mujeres"]
    },
    "Demografía y Edad": {
      "Edad promedio": data["edad_promedio"],
      "Índice de dependencia": data["indice_dependencia"],
      "Población < 15 años": data["pob_edad_014"],
      "Población 15-64 años": data["pob_edad_1564"],
      "Población > 65 años": data["pob_edad_65"]
    },
    "Educación y Empleo": {
      "Años promedio de estudio": data["anios_prom_estudio"],
      "Alfabetismo (%)": data["alfabetismo"],
    },
    "Vivienda": {
      "Total de viviendas particulares": data["viviendas_part"],
      "Total de hogares": data["total_hogares"],
      "Promedio de personas por hogar": data["prom_personas_hogar"],
      "Hogares con jefatura femenina": data["total_jefas_hogar"]
    }
  };

  
  let htmlContent = `
    <div class="col-12 mb-4">
      <h3 class="text-primary">${ubicacion || '—'}</h3>
    </div>
  `;

  
  for (const grupo in gruposDeDatos) {
    const items = gruposDeDatos[grupo];
    if (Object.keys(items).length > 0) {
      htmlContent += `<div class="col-12 mt-3"><h4>${grupo}</h4><hr></div>`;
      for (const [key, value] of Object.entries(items)) {
        htmlContent += `
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <h6 class="card-title text-secondary">${key}</h6>
                <p class="card-text fs-4 fw-bold text-primary">${fmt(value)}</p>
              </div>
            </div>
          </div>
        `;
      }
    }
  }


  const pueblos = extractPueblos(data);
  const totalPueblos = pueblos.reduce((s,p)=>s+p.value, 0);

  htmlContent += `
    <div class="col-12 mt-4">
      <h4>Población por pueblos</h4><hr>
    </div>

    <div class="col-12 col-lg-6">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Pueblo</th>
              <th class="text-end">Personas</th>
              <th class="text-end">%</th>
            </tr>
          </thead>
          <tbody id="tbodyPueblos">
            ${pueblos.map(p=>{
              const pct = totalPueblos ? (p.value/totalPueblos*100) : 0;
              return `<tr>
                <td>${p.name}</td>
                <td class="text-end">${fmt(p.value)}</td>
                <td class="text-end">${pct.toFixed(2)}%</td>
              </tr>`;
            }).join('')}
          </tbody>
          <tfoot>
            <tr>
              <th>Total</th>
              <th class="text-end">${fmt(totalPueblos)}</th>
              <th class="text-end">${totalPueblos ? '100%' : '—'}</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <canvas id="chartPueblos" height="160"></canvas>
      <div class="form-text">Si Chart.js está cargado en la página, verás aquí un gráfico de pastel.</div>
    </div>
  `;

  datosCensoDiv.innerHTML = htmlContent;

  
  if (window.Chart && document.getElementById('chartPueblos')) {
    const ctx = document.getElementById('chartPueblos');
    
    if (pueblos.length > 0) {
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: pueblos.map(p=>p.name),
          datasets: [{ data: pueblos.map(p=>p.value) }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }
  }
}


municipioSelector.addEventListener('change', (event) => {
  const codigoSeleccionado = event.target.value;
  obtenerDatosCenso(codigoSeleccionado);
});


document.addEventListener('DOMContentLoaded', () => {
  cargarMunicipios();
  const urlParams = new URLSearchParams(window.location.search);
  const municipioURL = urlParams.get('municipio');
  if (municipioURL) {
    municipioSelector.value = municipioURL;
    obtenerDatosCenso(municipioURL);
  } else {
    obtenerDatosCenso(municipioSelector.value);
  }
});


const h1 = document.querySelector('header h1');
const h2 = document.querySelector('header h2');
const p = document.querySelector('header p');

const infoOriginal = {
  h1: "Censo Nacional de Población y Vivienda",
  h2: "Departamento de El Progreso",
  p: "Explora los datos del censo de 2018 por municipio."
};

const infoPersonal = {
  h1: "Engelber Venceslav Cifuentes Moran",
  h2: "Carné: 1890-22-15397",
  p: ""
};

let mostrandoInfoOriginal = true;

function alternarBanner() {
  if (mostrandoInfoOriginal) {
    h1.textContent = infoPersonal.h1;
    h2.textContent = infoPersonal.h2;
    p.textContent = infoPersonal.p;
  } else {
    h1.textContent = infoOriginal.h1;
    h2.textContent = infoOriginal.h2;
    p.textContent = infoOriginal.p;
  }
  mostrandoInfoOriginal = !mostrandoInfoOriginal;
}

setInterval(alternarBanner, 5000);
</script>


</body>
</html>
